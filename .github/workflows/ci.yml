name: Dependency Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # Run weekly

jobs:
  dependency-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Cache Dependency-Check data
      uses: actions/cache@v4
      with:
        path: ~/.dependency-check-data
        key: ${{ runner.os }}-dependency-check-data
      
    - name: Run Dependency-Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'My Python Project'
        path: '.'
        format: 'HTML'
        out: 'reports'
        args: >
          --enableExperimental
          --scan **/*.py
          --scan requirements.txt
          --scan Pipfile
          --scan Pipfile.lock
          --scan poetry.lock
          --suppression suppress.xml
      
    - name: Upload Dependency-Check report
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-report
        path: reports/dependency-check-report.html
        
    - name: Fail on high severity vulnerabilities
      run: |
        if grep -q "CVSS score >= 8.0" reports/dependency-check-report.html; then
          echo "High severity vulnerabilities found!"
          exit 1
        fi
